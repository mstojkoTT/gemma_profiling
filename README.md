# gemma_profiling

## Reproduce steps

```
git clone --recurse-submodules https://github.com/mstojkoTT/gemma_profiling
cd gemma_profiling

python3 -m venv .venv
source .venv/bin/activate

pip install -r requirements.txt
```

Now put your HF token in `hf_token.txt`

# Results

## Results summary

We will outline a few numbers here:
- **GPU for 27b with use_fast=True: TTFT time=160ms, preprocessing time=32ms, preprocessing/TTFT=20.2%**
- **CPU for 27b with use_fast=True: TTFT time=4670ms, preprocessing time=41ms, preprocessing/TTFT=0.86%**
  

## Detailed results

Runs to average/median each datapoint: 10
Nr warmup runs: 10

Each cell has 3 numbers. To get those numbers we did 10 measurements (with 10 warmup iterations). The first number is the median of those 10 measurements, the second is the standard deviation of those 10 measurements, and the third number is the value of the largest deviation from the beforementioned median (the median in the same cell).

## 27b bfloat16
| Config              | ttft [s]            | preprocessing [s]    | img encoder [s]          | text model prefill [s]   | preproc./ttft [%]   | img. enc. tower time [s]   | img. enc. multi-modal projector time [s]   | preproc. / preproc. with overhead [s]   |
|:--------------------|:--------------------|:---------------------|:-------------------------|:-------------------------|:--------------------|:---------------------------|:-------------------------------------------|:----------------------------------------|
| cuda use_fast=True  | 0.16 0.00833 0.0274 | 0.0322 0.0091 0.0297 | 0.0262 0.00078 0.0026    | 0.08 0.000595 0.00152    | 20.2 5.56 18.3      | 0.026 0.000801 0.00267     | 0.000269 2.1e-05 6.7e-05                   | 95.2 8.63 28.6                          |
| cpu use_fast=True   | 4.67 0.519 1.22     | 0.0416 0.005 0.0119  | 2.96 0.251 0.642         | 1.67 0.326 0.613         | 0.868 0.0842 0.157  | 2.95 0.249 0.635           | 0.00921 0.00222 0.00734                    | 96.2 0.784 1.62                         |
| cuda use_fast=False | 0.215 0.0204 0.0681 | 0.0834 0.0197 0.0658 | 0.0262 0.000273 0.000847 | 0.08 0.000535 0.00104    | 38.7 8.02 26.8      | 0.0259 0.000284 0.000891   | 0.000266 1.21e-05 3.77e-05                 | 97.4 2.37 7.89                          |
| cpu use_fast=False  | 4.71 0.385 0.648    | 0.0877 0.026 0.0654  | 2.89 0.127 0.315         | 1.59 0.355 0.67          | 1.79 0.539 1.31     | 2.88 0.127 0.315           | 0.00917 0.000203 0.00044                   | 97.5 2.38 6.34                          |

## 27b float32
| Config              |
|:--------------------|
| cuda use_fast=True  |
| cpu use_fast=True   |
| cuda use_fast=False |
| cpu use_fast=False  |

## 4b bfloat16
| Config              | ttft [s]            | preprocessing [s]     | img encoder [s]          | text model prefill [s]   | preproc./ttft [%]   | img. enc. tower time [s]   | img. enc. multi-modal projector time [s]   | preproc. / preproc. with overhead [s]   |
|:--------------------|:--------------------|:----------------------|:-------------------------|:-------------------------|:--------------------|:---------------------------|:-------------------------------------------|:----------------------------------------|
| cuda use_fast=True  | 0.122 0.0197 0.0444 | 0.0445 0.018 0.0417   | 0.0262 0.00011 0.000324  | 0.0289 0.000635 0.00184  | 36.6 13.4 32.9      | 0.0259 0.000125 0.000356   | 0.000274 3.1e-05 6.9e-05                   | 96.6 11 27.5                            |
| cpu use_fast=True   | 3.56 0.112 0.223    | 0.0441 0.00596 0.0137 | 2.92 0.0746 0.182        | 0.607 0.106 0.24         | 1.27 0.16 0.4       | 2.91 0.0746 0.182          | 0.0107 0.0012 0.00313                      | 96.1 1.7 4.38                           |
| cuda use_fast=False | 0.165 0.0193 0.0644 | 0.0846 0.0184 0.0613  | 0.0262 0.000121 0.000268 | 0.0283 0.000225 0.000468 | 51.4 8.45 28.2      | 0.0259 0.000118 0.000256   | 0.000269 1.49e-05 4.73e-05                 | 97.5 1.71 5.7                           |
| cpu use_fast=False  | 3.42 0.109 0.241    | 0.0868 0.0198 0.0628  | 2.9 0.0569 0.108         | 0.384 0.0812 0.201       | 2.53 0.571 1.8      | 2.89 0.0572 0.109          | 0.0105 0.000764 0.0014                     | 97.3 1.82 6.07                          |

## 4b float32
| Config              | ttft [s]            | preprocessing [s]    | img encoder [s]       | text model prefill [s]   | preproc./ttft [%]   | img. enc. tower time [s]   | img. enc. multi-modal projector time [s]   | preproc. / preproc. with overhead [s]   |
|:--------------------|:--------------------|:---------------------|:----------------------|:-------------------------|:--------------------|:---------------------------|:-------------------------------------------|:----------------------------------------|
| cuda use_fast=True  | 0.363 0.0131 0.0395 | 0.0447 0.0128 0.0417 | 0.215 0.00178 0.00257 | 0.0826 0.00068 0.00137   | 12.3 3.47 11.4      | 0.215 0.00179 0.0026       | 0.000358 3.73e-05 8.64e-05                 | 96.1 8.38 27.8                          |
| cpu use_fast=True   | 3.13 0.314 0.615    | 0.0346 0.0141 0.0326 | 2.15 0.25 0.533       | 0.951 0.129 0.359        | 1.09 0.442 1.02     | 2.13 0.25 0.55             | 0.00293 0.0101 0.0339                      | 94.1 18.1 45.1                          |
| cuda use_fast=False | 0.396 0.018 0.0594  | 0.0782 0.0178 0.0594 | 0.215 0.00146 0.0028  | 0.0828 0.0004 0.000848   | 19.7 4.24 14.1      | 0.215 0.00147 0.0028       | 0.000362 3.24e-05 9.02e-05                 | 97.2 2.17 7.25                          |
| cpu use_fast=False  | 3.04 0.241 0.444    | 0.0763 0.0156 0.047  | 2.1 0.195 0.371       | 0.878 0.111 0.342        | 2.55 0.534 1.58     | 2.09 0.193 0.364           | 0.00313 0.0104 0.0345                      | 97.1 1.74 5.77                          |

## 12b bfloat16
| Config              | ttft [s]              | preprocessing [s]       | img encoder [s]          | text model prefill [s]   | preproc./ttft [%]   | img. enc. tower time [s]   | img. enc. multi-modal projector time [s]   | preproc. / preproc. with overhead [s]   |
|:--------------------|:----------------------|:------------------------|:-------------------------|:-------------------------|:--------------------|:---------------------------|:-------------------------------------------|:----------------------------------------|
| cuda use_fast=True  | 0.113 0.00125 0.00242 | 0.0205 0.000501 0.00127 | 0.0262 0.000117 0.000304 | 0.0439 0.000745 0.00168  | 18.2 0.289 0.771    | 0.0259 0.000116 0.0003     | 0.000273 3.44e-06 6.33e-06                 | 92.1 0.56 1.12                          |
| cpu use_fast=True   | 3.24 0.206 0.643      | 0.0214 0.00258 0.00809  | 2.29 0.181 0.566         | 0.892 0.03 0.0739        | 0.659 0.0791 0.194  | 2.29 0.181 0.566           | 0.00224 0.000162 0.00031                   | 91.3 1.65 5                             |
| cuda use_fast=False | 0.167 0.0029 0.00753  | 0.0742 0.00239 0.00616  | 0.0262 0.000108 0.000227 | 0.0432 0.000718 0.00122  | 44.7 0.672 1.63     | 0.0259 0.000109 0.000236   | 0.000269 4.98e-06 9.55e-06                 | 97.1 0.0723 0.183                       |
| cpu use_fast=False  | 3.28 0.0769 0.132     | 0.0745 0.0158 0.0489    | 2.29 0.0713 0.127        | 0.892 0.0208 0.0466      | 2.29 0.463 1.48     | 2.28 0.0712 0.127          | 0.00212 0.000115 0.000208                  | 96.9 1.86 6.18                          |

## 12b float32
| Config              | ttft [s]            | preprocessing [s]      | img encoder [s]       | text model prefill [s]   | preproc./ttft [%]   | img. enc. tower time [s]   | img. enc. multi-modal projector time [s]   | preproc. / preproc. with overhead [s]   |
|:--------------------|:--------------------|:-----------------------|:----------------------|:-------------------------|:--------------------|:---------------------------|:-------------------------------------------|:----------------------------------------|
| cuda use_fast=True  | 0.51 0.00468 0.0124 | 0.0212 0.00558 0.0184  | 0.217 0.00133 0.00344 | 0.252 0.0016 0.00319     | 4.15 1.09 3.58      | 0.217 0.00134 0.00353      | 0.00037 4.43e-05 0.000108                  | 91.2 6.36 20.9                          |
| cpu use_fast=True   | 5.24 0.233 0.52     | 0.0378 0.00165 0.00397 | 2.14 0.0933 0.193     | 2.97 0.155 0.281         | 0.728 0.0345 0.0826 | 2.14 0.0933 0.193          | 0.00318 0.000186 0.000538                  | 94.2 0.509 1                            |
| cuda use_fast=False | 0.577 0.0221 0.0715 | 0.0892 0.0219 0.0723   | 0.216 0.00137 0.00284 | 0.251 0.00154 0.00411    | 15.4 3.65 12.1      | 0.215 0.00138 0.00296      | 0.000378 3.71e-05 9.21e-05                 | 97.3 2.44 8.13                          |
| cpu use_fast=False  | 4.87 0.343 1.1      | 0.0798 0.0171 0.0515   | 1.98 0.0962 0.199     | 2.76 0.295 0.965         | 1.64 0.367 1.08     | 1.98 0.0962 0.199          | 0.0031 0.000155 0.000317                   | 97.1 1.69 5.58                          |


